<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>preBuild for hp2025 - LINE Final Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/1.0.11/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/upng-js@2.1.0/UPNG.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #eef2f3; text-align: center; padding: 20px; }
        #preview-container { width: 320px; height: 270px; background: #eee; margin: 0 auto 20px; border-radius: 8px; display: flex; align-items: center; justify-content: center; position: relative; border: 2px solid #ccc; }
        canvas { max-width: 100%; max-height: 100%; }
        .controls { margin-bottom: 20px; }
        button { padding: 12px 24px; font-weight: bold; cursor: pointer; border-radius: 5px; border: none; color: white; margin: 5px; }
        .btn-blue { background: #2196F3; }
        .btn-red { background: #f44336; }
        #frames-list { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .frame-item { background: white; padding: 5px 15px; border-radius: 5px; display: flex; align-items: center; gap: 10px; width: 300px; border: 1px solid #ddd; }
    </style>
</head>
<body>

    <h1>preBuild for hp2025 - LINE Final</h1>

    <div id="preview-container">
        <canvas id="preview-canvas" width="320" height="270"></canvas>
    </div>

    <div class="controls">
        <button class="btn-blue" onclick="autoFillFrames()">2・3枚目を20枚目までコピー</button>
        <button class="btn-red" onclick="generateLineAPNG()">LINEスタンプ生成</button>
    </div>

    <div id="frames-list"></div>

<script>
    const MAX_FRAMES = 20, WIDTH = 320, HEIGHT = 270;
    const frameBuffers = new Array(MAX_FRAMES).fill(null);
    const frameImages = new Array(MAX_FRAMES).fill(null);
    const mainCtx = document.getElementById('preview-canvas').getContext('2d');

    for (let i = 0; i < MAX_FRAMES; i++) {
        const div = document.createElement('div');
        div.className = 'frame-item';
        div.innerHTML = `<span style="width:20px">${i+1}</span><img id="thumb-${i}" style="width:40px;height:40px;object-fit:contain;background:#f0f0f0"><input type="file" accept="image/*" style="font-size:10px" onchange="loadFrame(${i}, this)">`;
        document.getElementById('frames-list').appendChild(div);
    }

    function loadFrame(index, input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const cvs = document.createElement('canvas');
                cvs.width = WIDTH; cvs.height = HEIGHT;
                const ctx = cvs.getContext('2d');
                ctx.clearRect(0,0,WIDTH,HEIGHT);
                const scale = Math.min(300/img.width, 250/img.height); // 余白確保
                ctx.drawImage(img, (WIDTH-img.width*scale)/2, (HEIGHT-img.height*scale)/2, img.width*scale, img.height*scale);
                frameImages[index] = cvs;
                frameBuffers[index] = ctx.getImageData(0,0,WIDTH,HEIGHT).data.buffer;
                document.getElementById(`thumb-${index}`).src = cvs.toDataURL();
                mainCtx.clearRect(0,0,WIDTH,HEIGHT); mainCtx.drawImage(cvs,0,0);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function autoFillFrames() {
        if (!frameBuffers[0] || !frameBuffers[1] || !frameBuffers[2]) return alert("3枚目まで入れてください");
        for (let i = 3; i < MAX_FRAMES; i++) {
            const src = (i % 2 === 1) ? 1 : 2;
            frameBuffers[i] = frameBuffers[src];
            frameImages[i] = frameImages[src];
            document.getElementById(`thumb-${i}`).src = document.getElementById(`thumb-${src}`).src;
        }
    }

    function generateLineAPNG() {
        const active = frameBuffers.filter(b => b !== null);
        if (active.length !== 20) return alert("20枚全て埋めてください");

        const delays = new Array(active.length).fill(200); // 0.2s
        const apng = UPNG.encode(active, WIDTH, HEIGHT, 256, delays);
        const view = new DataView(apng);
        
        let chunks = [], offset = 8;
        while (offset < apng.byteLength) {
            const len = view.getUint32(offset);
            const type = view.getUint32(offset + 4);
            const name = String.fromCharCode((type >> 24) & 0xff, (type >> 16) & 0xff, (type >> 8) & 0xff, type & 0xff);
            chunks.push({ name, data: apng.slice(offset, offset + 12 + len) });
            offset += 12 + len;
        }

        const result = [];
        result.push(new Uint8Array([0x89, 0x50, 0x4e, 0x47, 0x0d, 0x0a, 0x1a, 0x0a]).buffer);
        result.push(chunks.find(c => c.name === 'IHDR').data);
        
        const actl = chunks.find(c => c.name === 'acTL').data;
        new DataView(actl).setUint32(12, 1); // 1回再生 = 4.0s
        result.push(actl);

        const fctls = chunks.filter(c => c.name === 'fcTL');
        const idat = chunks.find(c => c.name === 'IDAT').data;
        const fdats = chunks.filter(c => c.name === 'fdAT').map(c => c.data);

        let seq = 0;
        function updateFcTL(chunk, s) {
            const dv = new DataView(chunk);
            dv.setUint32(8, s); // sequence_number
            dv.setUint16(28, 2); // delay_num (2)
            dv.setUint16(30, 10); // delay_den (10) -> 2/10 = 0.2s
            // CRC再計算はUPNGに任せたいが、手動結合のため簡易的に維持
            return chunk;
        }

        // 1フレーム目: fcTL(seq 0) -> IDAT
        result.push(updateFcTL(fctls[0].data, seq++));
        result.push(idat);

        // 2フレーム目以降: fcTL(seq++) -> fdAT
        for (let i = 0; i < fdats.length; i++) {
            result.push(updateFcTL(fctls[i+1].data, seq++));
            result.push(fdats[i]);
        }

        result.push(chunks.find(c => c.name === 'IEND').data);
        const blob = new Blob(result, { type: 'image/png' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `line_4s_final.png`; a.click();
    }
</script>
</body>
</html>
