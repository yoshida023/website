function generateLineAPNG() {
        const activeFrames = frameBuffers.filter(b => b !== null);
        if (activeFrames.length < 3) return alert("枚数が足りません");

        const delays = new Array(activeFrames.length).fill(100);
        // UPNGで生成
        const apngBuffer = UPNG.encode(activeFrames, WIDTH, HEIGHT, 256, delays);
        const view = new DataView(apngBuffer);
        
        let chunks = [];
        let offset = 8; 

        while (offset < apngBuffer.byteLength) {
            const len = view.getUint32(offset);
            const type = view.getUint32(offset + 4);
            const name = String.fromCharCode((type >> 24) & 0xff, (type >> 16) & 0xff, (type >> 8) & 0xff, type & 0xff);
            chunks.push({ name, data: apngBuffer.slice(offset, offset + 12 + len) });
            offset += 12 + len;
        }

        const result = [];
        result.push(new Uint8Array([0x89, 0x50, 0x4e, 0x47, 0x0d, 0x0a, 0x1a, 0x0a]).buffer);
        result.push(chunks.find(c => c.name === 'IHDR').data);
        
        // 1. acTL (2.0s × 2回 ＝ 4.0s)
        const actlChunk = chunks.find(c => c.name === 'acTL').data;
        new DataView(actlChunk).setUint32(12, 2); 
        result.push(actlChunk);

        // 2. フレームデータの並べ替え
        // UPNGが出力する fcTL は IDAT の前後に正しく配置されている必要があります
        // LINE用には [fcTL][IDAT], [fcTL][fdAT], [fcTL][fdAT]... の順序を徹底
        const fctls = chunks.filter(c => c.name === 'fcTL');
        const idat = chunks.find(c => c.name === 'IDAT');
        const fdats = chunks.filter(c => c.name === 'fdAT');

        // 1フレーム目
        if (fctls[0]) result.push(fctls[0].data);
        result.push(idat.data);

        // 2フレーム目以降
        for (let i = 0; i < fdats.length; i++) {
            if (fctls[i + 1]) result.push(fctls[i + 1].data);
            result.push(fdats[i].data);
        }

        result.push(chunks.find(c => c.name === 'IEND').data);

        const finalBlob = new Blob(result, { type: 'image/png' });
        const url = URL.createObjectURL(finalBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `line_animated_${Date.now()}.png`;
        link.click();
    }
