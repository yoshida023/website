<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>preBuild for hp2025 - LINE Stable</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/1.0.11/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/upng-js@2.1.0/UPNG.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #eef2f3; text-align: center; padding: 20px; }
        #preview-area { width: 320px; height: 270px; margin: 0 auto 20px; background: #eee; border: 2px solid #ccc; display: flex; align-items: center; justify-content: center; background-image: linear-gradient(45deg, #ddd 25%, transparent 25%), linear-gradient(-45deg, #ddd 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ddd 75%), linear-gradient(-45deg, transparent 75%, #ddd 75%); background-size: 20px 20px; }
        canvas { max-width: 100%; max-height: 100%; }
        button { padding: 12px 24px; font-weight: bold; cursor: pointer; margin: 5px; border-radius: 8px; border: none; color: white; }
        .btn-copy { background: #009688; }
        .btn-save { background: #d32f2f; box-shadow: 0 4px #b71c1c; }
        .btn-save:active { transform: translateY(2px); box-shadow: none; }
        #frames-list { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .frame-item { background: white; padding: 8px; border-radius: 5px; display: flex; align-items: center; gap: 10px; width: 340px; border: 1px solid #ddd; font-size: 12px; }
    </style>
</head>
<body>

    <h1>preBuild for hp2025 - 最終安定版</h1>

    <div id="preview-area"><canvas id="main-canvas" width="320" height="270"></canvas></div>

    <div class="controls">
        <button class="btn-copy" onclick="autoFill()">2枚目・3枚目をコピー</button>
        <button class="btn-save" onclick="saveForLine()">LINE用APNGを生成</button>
    </div>

    <div id="frames-list"></div>

<script>
    const MAX = 20, W = 320, H = 270;
    const buffers = new Array(MAX).fill(null);
    const ctx = document.getElementById('main-canvas').getContext('2d');

    for (let i = 0; i < MAX; i++) {
        const div = document.createElement('div');
        div.className = 'frame-item';
        div.innerHTML = `<span>${i+1}</span><img id="t-${i}" style="width:40px;height:40px;object-fit:contain;background:#f9f9f9"><input type="file" accept="image/*" onchange="load(${i}, this)">`;
        document.getElementById('frames-list').appendChild(div);
    }

    function load(i, input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const cvs = document.createElement('canvas');
                cvs.width = W; cvs.height = H;
                const c = cvs.getContext('2d');
                c.clearRect(0,0,W,H);
                const s = Math.min(300/img.width, 250/img.height); 
                c.drawImage(img, (W-img.width*s)/2, (H-img.height*s)/2, img.width*s, img.height*s);
                buffers[i] = c.getImageData(0,0,W,H).data.buffer;
                document.getElementById(`t-${i}`).src = cvs.toDataURL();
                ctx.clearRect(0,0,W,H); ctx.drawImage(cvs,0,0);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function autoFill() {
        if (!buffers[0] || !buffers[1] || !buffers[2]) return alert("3枚目まで読み込んでください");
        for (let i = 3; i < MAX; i++) {
            const src = (i % 2 === 1) ? 1 : 2;
            buffers[i] = buffers[src];
            document.getElementById(`t-${i}`).src = document.getElementById(`t-${src}`).src;
        }
    }

    function saveForLine() {
        const active = buffers.filter(b => b !== null);
        if (active.length !== 20) return alert("20枚すべて埋めてください");

        // ロスレス(0)でエンコード。これで「真っ黒」を防ぎます。
        const delays = new Array(active.length).fill(200); // 0.2s
        const apng = UPNG.encode(active, W, H, 0, delays);
        
        // ループ回数(acTL)だけを書き換える
        const view = new DataView(apng);
        let offset = 8;
        while (offset < apng.byteLength) {
            const len = view.getUint32(offset);
            const type = view.getUint32(offset + 4);
            if (type === 0x6163544C) { // acTLチャンク
                view.setUint32(offset + 12, 1); // ループ回数を1回に固定
                break;
            }
            offset += 12 + len;
        }

        const blob = new Blob([apng], { type: 'image/png' });
        
        if (blob.size > 320 * 1024) {
            alert("サイズオーバーです。画像の描き込みを減らしてください。");
        }

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `line_fixed_stable.png`; a.click();
        
        alert("4.0秒(1ループ)・フルカラーで生成しました。\nアップロードして動きを確認してください！");
    }
</script>
</body>
</html>
